name: init-gradle-wrapper
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  add-wrapper:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 1       
      matrix:
        template: [core-template, simple-template, form-template]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Gradle 8.2
        run: |
          wget -q https://services.gradle.org/distributions/gradle-8.2-bin.zip -O gradle.zip
          unzip -q gradle.zip

      # ✅ 这里用 named 配置已有的 wrapper 任务（不要再 register）
      - name: Generate wrapper in a temp project
        id: gen
        run: |
          TMP="$(mktemp -d)"
          cat > "$TMP/build.gradle" <<'EOF'
          import org.gradle.api.tasks.wrapper.Wrapper

          tasks.named('wrapper', Wrapper) {
              gradleVersion = '8.2'
              distributionType = Wrapper.DistributionType.ALL
          }
          EOF
          # 可选：给个 settings.gradle，避免 Gradle 往上层目录搜索
          echo "rootProject.name = 'tmp'" > "$TMP/settings.gradle"

          ./gradle-8.2/bin/gradle -p "$TMP" wrapper --no-daemon
          echo "TMP=$TMP" >> $GITHUB_OUTPUT

      - name: Copy wrapper into template and commit
        run: |
          set -e
          TEMPL_DIR="templates/${{ matrix.template }}"
          TMP="${{ steps.gen.outputs.TMP }}"

          mkdir -p "$TEMPL_DIR/gradle/wrapper"
          cp "$TMP/gradlew" "$TEMPL_DIR/gradlew"
          cp "$TMP/gradlew.bat" "$TEMPL_DIR/gradlew.bat"
          cp "$TMP/gradle/wrapper/"* "$TEMPL_DIR/gradle/wrapper/"

          git add "$TEMPL_DIR/gradlew" \
                  "$TEMPL_DIR/gradlew.bat" \
                  "$TEMPL_DIR/gradle/wrapper/gradle-wrapper.jar" \
                  "$TEMPL_DIR/gradle/wrapper/gradle-wrapper.properties" || true

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "Add Gradle wrapper to ${{ matrix.template }}" || echo "nothing to commit"
          git push
