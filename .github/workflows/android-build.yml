name: Android Build

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      runId:
        description: "NDJC run id"
        required: false
      template:
        description: "template key (core/simple/form)"
        required: false
      appTitle:
        description: "App title"
        required: false
      packageName:
        description: "Android applicationId"
        required: false
      branch:                       # ✅ 允许指定构建分支（如 ndjc-run/<runId>）
        description: "branch to build (e.g. ndjc-run/<runId>)"
        required: false

  # 服务端 route.ts 触发（只触发一次）
  repository_dispatch:
    types: [generate-apk]

concurrency:
  group: android-build-${{ github.event_name }}-${{ inputs.runId || github.event.client_payload.runId || inputs.branch || github.event.client_payload.ref || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      KS: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # ✅ 优先 workflow_dispatch.inputs.branch；其次 repository_dispatch 的 ref；最后当前 ref
          ref: ${{ inputs.branch || github.event.client_payload.ref || github.ref }}

      - name: NDJC | Show commit and changed files
        run: |
          echo "HEAD sha: $(git rev-parse HEAD)"
          echo "Triggered by: ${{ github.event_name }}"
          echo "inputs.branch: '${{ inputs.branch }}'"
          echo "client_payload.ref: '${{ github.event.client_payload.ref }}'"
          echo "client_payload.sha: '${{ github.event.client_payload.sha }}'"
          echo "---- files touched in this commit ----"
          git show --name-only --pretty=oneline "$(git rev-parse HEAD)"

      - name: Sanity check
        run: |
          test -f ./gradlew || { echo "gradlew missing"; exit 1; }
          test -d app || { echo "app/ missing"; exit 1; }
          test -f app/build.gradle -o -f app/build.gradle.kts || { echo "app Gradle file missing"; exit 1; }

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # ==========================
      # ✅ 保证线上一定会跑的 Preflight
      # 1) 若当前分支没有 scripts/preflight_all.sh，会从 main 抓一份
      # 2) 预检包括锚点自检 + 资源/Manifest 预编译；日志写入 build-logs/**
      # 3) 预检失败会直接让 Job 失败
      # ==========================
      - name: NDJC | Preflight (anchor & resource checks)
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p build-logs anchors || true

          # 拉取缺失的预检脚本
          if [ ! -f scripts/preflight_all.sh ]; then
            echo "[Preflight] scripts/preflight_all.sh not found in branch -> fetch from main"
            git fetch origin main --depth=1
            git show origin/main:scripts/preflight_all.sh > scripts/preflight_all.sh
          fi
          chmod +x scripts/preflight_all.sh

          # 确保 PowerShell 自检脚本在当前分支存在（脚本会用到）
          if [ ! -f Tools/ndjc-selfcheck.ps1 ]; then
            echo "[Preflight] Tools/ndjc-selfcheck.ps1 not found in branch -> fetch from main"
            git fetch origin main --depth=1
            git show origin/main:Tools/ndjc-selfcheck.ps1 > Tools/ndjc-selfcheck.ps1
          fi

          echo "==== NDJC Preflight start ===="

          # 先做锚点/模板自检（优先使用 pwsh，其次 powershell）
          if command -v pwsh >/dev/null 2>&1; then
            pwsh -NoProfile -File ./Tools/ndjc-selfcheck.ps1
          else
            if command -v powershell >/dev/null 2>&1; then
              powershell -NoProfile -ExecutionPolicy Bypass -File ./Tools/ndjc-selfcheck.ps1
            else
              echo "::error ::Neither pwsh nor powershell found on runner."
              exit 1
            fi
          fi

          # 资源/Manifest 早期预编译（把潜在错误一次性暴露到日志里）
          ./gradlew clean :app:processReleaseResources :app:lintRelease \
            --stacktrace --info --console=plain 2>&1 | tee build-logs/full-diagnostics.log

          # 从长日志中提取关键错误，便于快速定位
          echo "---- critical summary ----"
          (grep -nE "What went wrong|Execution failed|error:|AAPT|Duplicate class|Manifest merger|not found|FAILED" build-logs/full-diagnostics.log || true) \
            | sed -E 's/^[^:]+:([0-9]+):/\1/' | sort -n | uniq
          echo "-------------------------"

          echo "==== NDJC Preflight done ===="

      - name: NDJC | Upload preflight logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: preflight-logs
          path: |
            build-logs/**
            anchors/**
          if-no-files-found: ignore

      # ==========================
      # 真正构建
      # ==========================
      - name: Build
        id: build
        shell: bash
        run: |
          set -e
          if [ -z "${KS}" ]; then
            echo "No keystore → build Debug"
            ./gradlew :app:clean :app:assembleDebug -x lint --stacktrace
            OUTDIR=app/build/outputs/apk/debug
            VARIANT=debug
          else
            echo "Keystore present → build Release"
            ./gradlew :app:clean :app:assembleRelease -x lint --stacktrace
            OUTDIR=app/build/outputs/apk/release
            VARIANT=release
          fi
          echo "APK_DIR=$OUTDIR"   >> "$GITHUB_ENV"
          echo "VARIANT=$VARIANT"  >> "$GITHUB_ENV"

      - name: Pick APK
        shell: bash
        run: |
          set -e
          SIGNED=$(ls -t "$APK_DIR"/*.apk 2>/dev/null | grep -Ev -- '-unsigned\.apk$' | head -n1 || true)
          UNSIGNED=$(ls -t "$APK_DIR"/*-unsigned.apk 2>/dev/null | head -n1 || true)
          APK=""
          if [ -n "$SIGNED" ]; then
            APK="$SIGNED"
            echo "Found signed APK: $APK"
          elif [ -n "$UNSIGNED" ]; then
            APK="$UNSIGNED"
            echo "Found unsigned APK: $APK"
          else
            echo "No APK found under $APK_DIR"
            exit 1
          fi
          echo "APK=$APK" >> "$GITHUB_ENV"

      - name: Fallback sign release APK (if unsigned but keystore present)
        if: ${{ env.KS != '' && env.VARIANT == 'release' }}
        shell: bash
        run: |
          if echo "${APK}" | grep -q -- '-unsigned\.apk$'; then
            OUT="${APK%-unsigned.apk}.apk"
            echo "Unsigned APK → signing: ${APK} -> ${OUT}"
            "$ANDROID_SDK_ROOT/build-tools/34.0.0/apksigner" sign \
              --ks "$NDJC_KEYSTORE_PATH" \
              --ks-pass pass:"$NDJC_KEYSTORE_PASSWORD" \
              --key-pass pass:"$NDJC_KEY_PASSWORD" \
              --ks-key-alias "$NDJC_KEY_ALIAS" \
              --out "$OUT" "$APK"
            ls -lh "$OUT"
            echo "APK=$OUT" >> "$GITHUB_ENV"
          else
            echo "APK already signed: ${APK}"
          fi

      - name: Verify Release signature
        if: ${{ env.VARIANT == 'release' }}
        run: |
          "$ANDROID_SDK_ROOT/build-tools/34.0.0/apksigner" verify --verbose --print-certs "${APK}"

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ env.VARIANT }}
          path: ${{ env.APK }}
          if-no-files-found: error
