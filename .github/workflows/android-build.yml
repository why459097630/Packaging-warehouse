name: Android Build (NDJC • Core-Templates minimal) 

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: "NDJC request run id (e.g. ndjc-20251217T193539Z)"
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 关键：把 requests/<run_id>/assembly.local.json 变成后面脚本会读的 lib/ndjc/assembly.local.json
      - name: NDJC | Materialize request -> lib/ndjc/assembly.local.json
        shell: bash
        run: |
          set -euo pipefail
          RUN_ID="${{ inputs.run_id }}"
          SRC="requests/${RUN_ID}/assembly.local.json"
          DST="lib/ndjc/assembly.local.json"

          if [ ! -f "$SRC" ]; then
            echo "Missing request file: $SRC"
            ls -la "requests/${RUN_ID}" || true
            exit 1
          fi

          mkdir -p "$(dirname "$DST")"
          cp -f "$SRC" "$DST"
          echo "Wrote $DST from $SRC"
          ls -la "$DST" || true

      # 可选：把 requests/<run_id>/icon.png 变成 lib/ndjc/icon.png
      - name: NDJC | Materialize icon -> lib/ndjc/icon.png (optional)
        shell: bash
        run: |
          set -euo pipefail
          RUN_ID="${{ inputs.run_id }}"
          SRC="requests/${RUN_ID}/icon.png"
          DST="lib/ndjc/icon.png"

          if [ -f "$SRC" ]; then
            mkdir -p "$(dirname "$DST")"
            cp -f "$SRC" "$DST"
            echo "Wrote $DST from $SRC"
            ls -la "$DST" || true

            # --- NDJC: Force-convert to a valid PNG to avoid AAPT2 compile failures ---
            # Ensure ImageMagick exists
            if ! command -v magick >/dev/null 2>&1 && ! command -v convert >/dev/null 2>&1; then
              echo "[NDJC] Installing ImageMagick..."
              sudo apt-get update -y
              sudo apt-get install -y imagemagick
            fi

            echo "[NDJC] icon file type before convert:"
            file "$DST" || true

            TMP="${DST}.tmp.png"
            if command -v magick >/dev/null 2>&1; then
              magick "$DST" -strip PNG32:"$TMP"
            else
              convert "$DST" -strip PNG32:"$TMP"
            fi

            mv -f "$TMP" "$DST"

            echo "[NDJC] icon file type after convert:"
            file "$DST" || true
            ls -la "$DST" || true
            # Quick signature check (must start with 89 50 4E 47)
            head -c 8 "$DST" | xxd || true
          else
            echo "No icon uploaded for $RUN_ID (skip)"
          fi


      - name: NDJC | Core-Templates assembly
        shell: bash
        run: |
          set -euo pipefail
          bash scripts/ndjc-assembly.sh

      - name: Install dependencies (if needed)
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -f package.json ]; then
            echo "No package.json, skip node deps"
            exit 0
          fi

          # NDJC APK 构建主链路不依赖 node_modules。
          # 只有当锁文件存在时才安装，避免 npm install 造成不确定性和 registry 问题。
          if [ -f pnpm-lock.yaml ]; then
            corepack enable || true
            pnpm install --frozen-lockfile
          else
            echo "No pnpm-lock.yaml found; skip installing node deps."
            ls -la
          fi

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          
      - name: Debug | show settings.gradle(.kts)
        shell: bash
        run: |
          set -euo pipefail
          echo "===== settings.gradle ====="
          if [ -f settings.gradle ]; then sed -n '1,200p' settings.gradle; else echo "no settings.gradle"; fi
          echo "===== settings.gradle.kts ====="
          if [ -f settings.gradle.kts ]; then sed -n '1,240p' settings.gradle.kts; else echo "no settings.gradle.kts"; fi

      - name: Debug | list projects & tasks
        shell: bash
        run: |
          set -euo pipefail
          ./gradlew projects --no-daemon
          ./gradlew tasks --all --no-daemon | sed -n '1,200p'

      - name: NDJC | Prepare Release Keystore (generate or decode)
        shell: bash
        run: |
          set -euo pipefail
          ASSEMBLY="lib/ndjc/assembly.local.json"

          KS_B64="$(ASSEMBLY="$ASSEMBLY" node -e "const fs=require('fs'); const j=JSON.parse(fs.readFileSync(process.env.ASSEMBLY,'utf8')); process.stdout.write(((j.keystoreBase64||j.signing?.keystoreBase64||'')+'').trim());")"
          KS_PASS="$(ASSEMBLY="$ASSEMBLY" node -e "const fs=require('fs'); const j=JSON.parse(fs.readFileSync(process.env.ASSEMBLY,'utf8')); process.stdout.write(((j.keystorePassword||j.signing?.keystorePassword||'')+'').trim());")"
          KEY_ALIAS="$(ASSEMBLY="$ASSEMBLY" node -e "const fs=require('fs'); const j=JSON.parse(fs.readFileSync(process.env.ASSEMBLY,'utf8')); process.stdout.write(((j.keyAlias||j.signing?.keyAlias||'ndjc_upload')+'').trim());")"
          KEY_PASS="$(ASSEMBLY="$ASSEMBLY" node -e "const fs=require('fs'); const j=JSON.parse(fs.readFileSync(process.env.ASSEMBLY,'utf8')); process.stdout.write(((j.keyPassword||j.signing?.keyPassword||'')+'').trim());")"

          KS_PATH="$GITHUB_WORKSPACE/lib/ndjc/ndjc-upload-keystore.jks"

          if [ -n "$KS_B64" ]; then
            echo "$KS_B64" | base64 -d > "$KS_PATH"
            echo "[NDJC] Using provided keystore from assembly"
            if [ -z "$KS_PASS" ] || [ -z "$KEY_PASS" ]; then
              echo "::error::Keystore provided but password missing (keystorePassword/keyPassword)."
              exit 1
            fi
          else
            echo "[NDJC] No keystore provided; generating a new upload keystore for this build"
            if [ -z "$KS_PASS" ]; then KS_PASS="$(openssl rand -hex 12)"; fi
            if [ -z "$KEY_PASS" ]; then KEY_PASS="$KS_PASS"; fi

            keytool -genkeypair \
              -keystore "$KS_PATH" \
              -storepass "$KS_PASS" \
              -keypass "$KEY_PASS" \
              -alias "$KEY_ALIAS" \
              -keyalg RSA -keysize 2048 -validity 10000 \
              -dname "CN=NDJC, OU=NDJC, O=NDJC, L=NA, ST=NA, C=US"
          fi

          echo "NDJC_KEYSTORE_PATH=$KS_PATH" >> "$GITHUB_ENV"
          echo "NDJC_KEYSTORE_PASSWORD=$KS_PASS" >> "$GITHUB_ENV"
          echo "NDJC_KEY_ALIAS=$KEY_ALIAS" >> "$GITHUB_ENV"
          echo "NDJC_KEY_PASSWORD=$KEY_PASS" >> "$GITHUB_ENV"

          ls -la "$KS_PATH"

      - name: NDJC | Write signing-info.txt (handoff)
        shell: bash
        run: |
          set -euo pipefail

          SIGNING_INFO="lib/ndjc/signing-info.txt"
          PUBLISH_INFO="lib/ndjc/publish-info.txt"

          mkdir -p "lib/ndjc"

          {
            echo "NDJC Signing Info (handoff)"
            echo "- keystoreFile: ndjc-upload-keystore.jks"
            echo "- keystorePath: ${NDJC_KEYSTORE_PATH}"
            echo "- keyAlias: ${NDJC_KEY_ALIAS}"
            echo "- storePassword: ${NDJC_KEYSTORE_PASSWORD}"
            echo "- keyPassword: ${NDJC_KEY_PASSWORD}"
            echo
            echo "Certificate fingerprints:"
            keytool -list -v -keystore "${NDJC_KEYSTORE_PATH}" -storepass "${NDJC_KEYSTORE_PASSWORD}" -alias "${NDJC_KEY_ALIAS}" | sed -n '1,200p'
          } > "${SIGNING_INFO}"

          if [ ! -f "${PUBLISH_INFO}" ]; then
            echo "NDJC Publish Info" > "${PUBLISH_INFO}"
          fi

          {
            echo
            echo "(Signing summary)"
            echo "- keystoreFile: ndjc-upload-keystore.jks"
            echo "- keyAlias: ${NDJC_KEY_ALIAS}"
            echo "- (Passwords in signing-info.txt)"
          } >> "${PUBLISH_INFO}"

          echo "[NDJC] Wrote ${SIGNING_INFO}"
          ls -la "${SIGNING_INFO}" || true


      - name: Build Release (APK + AAB)
        shell: bash
        run: |
          set -euo pipefail
          cd templates/Core-Templates
          chmod +x ./gradlew
          ./gradlew assembleRelease bundleRelease --no-daemon

      - name: Rename outputs to user app name (APK + AAB) and prepare artifact name
        shell: bash
        run: |
          set -euo pipefail

          # 读 assembly.local.json 里的 appName（用于文件名）
          APP_NAME_RAW="$(node -e "const fs=require('fs'); const j=JSON.parse(fs.readFileSync('lib/ndjc/assembly.local.json','utf8')); process.stdout.write(((j.appName||j.app_label||'NDJC App')+'').trim());")"

          # 文件名：允许中文，但至少要去掉路径分隔符等危险字符（/ 和 \\ 必须处理）
          SAFE_APK_NAME="$(printf '%s' "$APP_NAME_RAW" | sed 's#[/\\]#_#g')"
          if [ -z "$SAFE_APK_NAME" ]; then SAFE_APK_NAME="NDJC App"; fi

          APK_DIR="templates/Core-Templates/app/build/outputs/apk/release"
          APK_SRC="$(ls -1 "$APK_DIR"/*.apk | head -n 1)"
          APK_OUT="$APK_DIR/${SAFE_APK_NAME}.apk"

          AAB_DIR="templates/Core-Templates/app/build/outputs/bundle/release"
          AAB_SRC="$(ls -1 "$AAB_DIR"/*.aab | head -n 1)"
          AAB_OUT="$AAB_DIR/${SAFE_APK_NAME}.aab"

          cp -f "$APK_SRC" "$APK_OUT"
          cp -f "$AAB_SRC" "$AAB_OUT"

          # 固定 artifact 名（最终下载到的就是 NDJC-app.zip）
          echo "NDJC_ARTIFACT_NAME=NDJC-app" >> "$GITHUB_ENV"
          echo "NDJC_APK_OUT=$APK_OUT" >> "$GITHUB_ENV"
          echo "NDJC_AAB_OUT=$AAB_OUT" >> "$GITHUB_ENV"

          echo "Renamed APK -> $APK_OUT"
          echo "Renamed AAB -> $AAB_OUT"
          ls -la "$APK_DIR"
          ls -la "$AAB_DIR"
            - name: NDJC | Collect deliverables (flatten)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          # APK / AAB（按你现有 env 指向的输出文件拷贝）
          cp -f "${{ env.NDJC_APK_OUT }}" dist/ || true
          cp -f "${{ env.NDJC_AAB_OUT }}" dist/ || true

          # Keystore & info files
          cp -f lib/ndjc/ndjc-upload-keystore.jks dist/ || true
          cp -f lib/ndjc/publish-info.txt dist/ || true
          cp -f lib/ndjc/signing-info.txt dist/ || true

          echo "[NDJC] dist contents:"
          ls -la dist


      - name: Upload Release artifacts (APK + AAB + keystore + publish-info)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.NDJC_ARTIFACT_NAME }}
          path: dist/**
          if-no-files-found: error
          retention-days: 14


