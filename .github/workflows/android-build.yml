name: NDJC Android Build

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:
    inputs:
      runId:
        description: "NDJC run id (用于关联整条链路)"
        type: string
        required: false
        default: ""
      template:
        description: "Template folder name"
        type: choice
        options: [simple-template, core-template, form-template]
        default: simple-template
      feature:
        description: "Feature to inject"
        type: choice
        options: [dice, timer, todo]
        default: dice
      appTitle:
        description: "App title"
        type: string
        default: "NDJC Demo"
      mainButton:
        description: "Main button text"
        type: string
        default: "Get Started"
      packageName:
        description: "Android package name"
        type: string
        default: "com.ndjc.demo"
      buildType:
        description: "Gradle build type"
        type: choice
        options: [Release, Debug]
        default: Release

jobs:
  build-android:
    runs-on: ubuntu-latest

    # 统一 Run Id（优先取 inputs.runId，否则退回 github.run_id）
    env:
      RUN_ID: ${{ github.event.inputs.runId != '' && github.event.inputs.runId || github.run_id }}

      # 如果你用签名，可在仓库 Secrets 配置这些（可选）
      KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
      KEYSTORE_PASS:   ${{ secrets.KEYSTORE_PASS }}
      KEY_ALIAS:       ${{ secrets.KEY_ALIAS }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java (JDK 17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Install Android SDK components
        uses: android-actions/setup-android@v3

      - name: Accept SDK licenses
        run: yes | sdkmanager --licenses

      - name: Install build-tools & platforms
        run: |
          sdkmanager "platform-tools" \
                     "platforms;android-33" \
                     "build-tools;33.0.1"

      - name: Restore keystore (optional)
        if: env.KEYSTORE_BASE64 != ''
        run: |
          mkdir -p keystore
          echo "$KEYSTORE_BASE64" | base64 -d > keystore/ndjc.keystore

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Show RUN_ID
        run: |
          echo "RUN_ID=${{ env.RUN_ID }}"
          echo "RUN_ID=${{ env.RUN_ID }}" >> $GITHUB_ENV

      # 使用同一入口脚本（与你本地一致）
      - name: Build with unified script
        shell: pwsh
        run: |
          $template    = "${{ github.event.inputs.template }}"
          $feature     = "${{ github.event.inputs.feature }}"
          $appTitle    = "${{ github.event.inputs.appTitle }}"
          $mainButton  = "${{ github.event.inputs.mainButton }}"
          $packageName = "${{ github.event.inputs.packageName }}"
          $buildType   = "${{ github.event.inputs.buildType }}"

          # 让脚本可从环境读取 RUN_ID
          $env:RUN_ID = "${{ env.RUN_ID }}"

          $ksPath = ""
          if ("${{ env.KEYSTORE_BASE64 }}" -ne "") {
            $ksPath = "keystore/ndjc.keystore"
          }

          pwsh ./scripts/build-android.ps1 `
            -Template $template `
            -Feature $feature `
            -AppTitle $appTitle `
            -MainButton $mainButton `
            -PackageName $packageName `
            -BuildType $buildType `
            -CheckAnchors `
            $(if ($ksPath) { "-KeystorePath $ksPath -KeystorePass '${{ env.KEYSTORE_PASS }}' -KeyAlias '${{ env.KEY_ALIAS }}'" })

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ndjc-apk-${{ env.RUN_ID }}
          path: |
            dist/**/apk/*.apk
            dist/**/ndjc_summary.md
            dist/**/requests/**

      # （可选）创建 GitHub Release 并附带 APK
      - name: Create Release (optional)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v0.${{ github.run_number }}
          name: "NDJC Android v0.${{ github.run_number }}"
          draft: false
          prerelease: true
          files: |
            dist/**/apk/*.apk
            dist/**/ndjc_summary.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
