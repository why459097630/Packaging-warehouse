name: Android Build (NDJC ‚Ä¢ Core-Templates minimal)

on:
  workflow_dispatch:
    inputs:
      template:
        description: "Core-Templates template id"
        required: false
        default: "core-skeleton"
      uiPack:
        description: "UI pack folder name"
        required: true
      modules:
        description: 'JSON array string, e.g. ["feature-restaurant-menu-full"]'
        required: true
      appName:
        description: "App display name"
        required: false
        default: "NDJC App"
      iconBase64:
        description: "Base64 PNG (512x512 recommended)"
        required: false
        default: ""

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # ÂÜô assembly.local.jsonÔºàË£ÖÈÖçÂêàÂêåÔºâ
      - name: NDJC | Write assembly.local.json
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p lib/ndjc

          TEMPLATE="${{ inputs.template }}"
          UIPACK="${{ inputs.uiPack }}"
          MODULES_JSON='${{ inputs.modules }}'

          node -e "const v=${MODULES_JSON}; if(!Array.isArray(v)) process.exit(1)"

          cat > lib/ndjc/assembly.local.json <<EOF
          {
            "template": "${TEMPLATE}",
            "uiPack": "${UIPACK}",
            "modules": ${MODULES_JSON}
          }
          EOF

          cat lib/ndjc/assembly.local.json

      # Ê≥®ÂÖ• appName
      - name: NDJC | Inject appName
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import re, pathlib
          p = pathlib.Path("templates/Core-Templates/app/src/main/res/values/strings.xml")
          s = p.read_text(encoding="utf-8")
          s = re.sub(
            r'(<string\\s+name="app_name">)(.*?)(</string>)',
            r'\\1' + "${{ inputs.appName }}" + r'\\3',
            s,
            flags=re.S
          )
          p.write_text(s, encoding="utf-8")
          PY

      # =========================
      # üî• ÂÖ≥ÈîÆÂ¢ûÂº∫ÔºöÂÆåÊï¥ Icon Ê≥®ÂÖ•
      # =========================
      - name: NDJC | Inject FULL Android launcher icons
        if: ${{ inputs.iconBase64 != '' }}
        shell: bash
        run: |
          set -euo pipefail

          sudo apt-get update
          sudo apt-get install -y imagemagick

          mkdir -p tmp/icons
          echo "${{ inputs.iconBase64 }}" | base64 -d > tmp/icon.png

          RES="templates/Core-Templates/app/src/main/res"

          declare -A SIZES=(
            ["mipmap-mdpi"]=48
            ["mipmap-hdpi"]=72
            ["mipmap-xhdpi"]=96
            ["mipmap-xxhdpi"]=144
            ["mipmap-xxxhdpi"]=192
          )

          for dir in "${!SIZES[@]}"; do
            size="${SIZES[$dir]}"
            mkdir -p "$RES/$dir"
            convert tmp/icon.png -resize ${size}x${size} "$RES/$dir/ic_launcher.png"
          done

          # adaptive icon (Android 8+)
          mkdir -p "$RES/mipmap-anydpi-v26"

          cat > "$RES/mipmap-anydpi-v26/ic_launcher.xml" <<EOF
          <?xml version="1.0" encoding="utf-8"?>
          <adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
              <background android:drawable="@android:color/white"/>
              <foreground android:drawable="@mipmap/ic_launcher_foreground"/>
          </adaptive-icon>
          EOF

          # foreground ÂõæÂ±Ç
          convert tmp/icon.png -resize 432x432 "$RES/mipmap-xxxhdpi/ic_launcher_foreground.png"

          echo "‚úî All launcher icons injected (mdpi ‚Üí xxxhdpi + adaptive)"

      # NDJC Ë£ÖÈÖç
      - name: NDJC | Core-Templates assembly
        shell: bash
        run: |
          set -euo pipefail
          bash scripts/ndjc-assembly.sh

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Gradle cache
        uses: gradle/actions/setup-gradle@v3

      - name: Pre-clean Gradle
        working-directory: templates/Core-Templates
        shell: bash
        run: |
          chmod +x ./gradlew
          ./gradlew --stop || true
          ./gradlew clean --no-daemon

      - name: Build APK (debug)
        working-directory: templates/Core-Templates
        shell: bash
        run: |
          ./gradlew --no-daemon :app:assembleDebug

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ndjc-apk-${{ github.run_id }}
          path: templates/Core-Templates/app/build/outputs/**/*.apk
          retention-days: 14
