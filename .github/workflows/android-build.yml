name: Android Build (NDJC • Core-Templates minimal)

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: "NDJC run id (used for tracing)"
        required: true
        type: string
      app_name:
        description: "App display name"
        required: true
        type: string
      template_key:
        description: "Template key (e.g. shop-basic)"
        required: true
        type: string
      ui_pack:
        description: "UI pack (e.g. ui-pack-neumorph)"
        required: false
        type: string
      modules:
        description: "Comma-separated feature modules"
        required: false
        type: string
      icon_base64:
        description: "Optional: dataURL or base64 for PNG/JPG"
        required: false
        type: string

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (Packaging-warehouse)
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 关键新增：把 workflow inputs 写入 lib/ndjc/assembly.local.json
      - name: NDJC | Write lib/ndjc/assembly.local.json from inputs
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p lib/ndjc

          node - <<'NODE'
          const fs = require("fs");

          const runId = process.env.INPUT_RUN_ID || "";
          const appName = process.env.INPUT_APP_NAME || "NDJC App";
          const templateKey = process.env.INPUT_TEMPLATE_KEY || "shop-basic";
          const uiPack = process.env.INPUT_UI_PACK || "";
          const modulesRaw = process.env.INPUT_MODULES || "";
          const iconBase64 = process.env.INPUT_ICON_BASE64 || "";

          const modules = modulesRaw
            .split(",")
            .map(s => s.trim())
            .filter(Boolean);

          const assembly = {
            runId,
            mode: "compose",
            templateKey,
            uiPack,
            modules,
            meta: {
              appName,
              iconBase64
            }
          };

          fs.writeFileSync(
            "lib/ndjc/assembly.local.json",
            JSON.stringify(assembly, null, 2),
            "utf8"
          );

          console.log("Wrote lib/ndjc/assembly.local.json");
          NODE

          echo "----- assembly.local.json -----"
          cat lib/ndjc/assembly.local.json

      - name: NDJC | Core-Templates assembly
        shell: bash
        run: |
          set -euo pipefail
          bash scripts/ndjc-assembly.sh

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Gradle cache
        uses: gradle/actions/setup-gradle@v3

      - name: Pre-clean Gradle (stop daemons & clean)
        working-directory: templates/Core-Templates
        shell: bash
        run: |
          set -euo pipefail
          chmod +x ./gradlew
          ./gradlew --stop || true
          ./gradlew clean --no-daemon --stacktrace

      - name: Build APK (debug)
        id: build_apk
        working-directory: templates/Core-Templates
        shell: bash
        run: |
          set -euo pipefail
          ./gradlew --no-daemon --stacktrace :app:assembleDebug

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ndjc-apk-${{ github.run_id }}
          path: |
            templates/Core-Templates/app/build/outputs/**/*.apk
          if-no-files-found: error
          retention-days: 14
