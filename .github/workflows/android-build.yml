name: Android Build (NDJC • Core-Templates minimal)

on:
  # 只保留手动触发，点 Run workflow 就能打包
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1) 拉取当前仓库代码
      - name: Checkout (Packaging-warehouse)
        uses: actions/checkout@v4

      # 2) 安装 Node.js（ndjc-assembly.sh 里要跑 ndjc-sst-checker.js）
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3) NDJC Core-Templates 组合装配 + 契约自检
      - name: NDJC | Core-Templates assembly
        shell: bash
        run: |
          set -euo pipefail
          bash scripts/ndjc-assembly.sh

      # 4) 安装 JDK 17
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 5) 配置 Gradle 缓存（可加快构建速度）
      - name: Setup Gradle cache
        uses: gradle/actions/setup-gradle@v3

      # 6) 预清理 Gradle（在 Core-Templates 工程内）
      - name: Pre-clean Gradle (stop daemons & clean)
        working-directory: templates/Core-Templates
        shell: bash
        run: |
          set -euo pipefail
          ./gradlew --stop || true
          ./gradlew clean --no-daemon --stacktrace

      # 7) 构建 Debug APK（需要 Release 的话把 assembleDebug 改成 assembleRelease）
      - name: Build APK (debug)
        id: build_apk
        working-directory: templates/Core-Templates
        shell: bash
        run: |
          set -euo pipefail
          ./gradlew --no-daemon --stacktrace :app:assembleDebug

      # 8) 上传 APK 构建产物
      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          # 用 run id 区分每次构建
          name: ndjc-apk-${{ github.run_id }}
          path: |
            templates/Core-Templates/app/build/outputs/**/*.apk
          if-no-files-found: error
          retention-days: 14
