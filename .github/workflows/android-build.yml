name: Android Build (NDJC • Core-Templates minimal) 

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: "NDJC request run id (e.g. ndjc-20251217T193539Z)"
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 关键：把 requests/<run_id>/assembly.local.json 变成后面脚本会读的 lib/ndjc/assembly.local.json
      - name: NDJC | Materialize request -> lib/ndjc/assembly.local.json
        shell: bash
        run: |
          set -euo pipefail
          RUN_ID="${{ inputs.run_id }}"
          SRC="requests/${RUN_ID}/assembly.local.json"
          DST="lib/ndjc/assembly.local.json"

          if [ ! -f "$SRC" ]; then
            echo "Missing request file: $SRC"
            ls -la "requests/${RUN_ID}" || true
            exit 1
          fi

          mkdir -p "$(dirname "$DST")"
          cp -f "$SRC" "$DST"
          echo "Wrote $DST from $SRC"
          ls -la "$DST" || true

      # 可选：把 requests/<run_id>/icon.png 变成 lib/ndjc/icon.png
      - name: NDJC | Materialize icon -> lib/ndjc/icon.png (optional)
        shell: bash
        run: |
          set -euo pipefail
          RUN_ID="${{ inputs.run_id }}"
          SRC="requests/${RUN_ID}/icon.png"
          DST="lib/ndjc/icon.png"

          if [ -f "$SRC" ]; then
            mkdir -p "$(dirname "$DST")"
            cp -f "$SRC" "$DST"
            echo "Wrote $DST from $SRC"
            ls -la "$DST" || true
          else
            echo "No icon uploaded for $RUN_ID (skip)"
          fi

      - name: NDJC | Core-Templates assembly
        shell: bash
        run: |
          set -euo pipefail
          bash scripts/ndjc-assembly.sh

      - name: Install dependencies (if needed)
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -f package.json ]; then
            echo "No package.json, skip node deps"
            exit 0
          fi

          # NDJC APK 构建主链路不依赖 node_modules。
          # 只有当锁文件存在时才安装，避免 npm install 造成不确定性和 registry 问题。
          if [ -f pnpm-lock.yaml ]; then
            corepack enable
            pnpm --version
            pnpm install --frozen-lockfile
          else
            echo "No pnpm-lock.yaml found; skip installing node deps."
            ls -la
          fi

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          
      - name: Debug | show settings.gradle(.kts)
        shell: bash
        run: |
          set -euo pipefail
          echo "===== settings.gradle ====="
          if [ -f settings.gradle ]; then sed -n '1,200p' settings.gradle; else echo "no settings.gradle"; fi
          echo "===== settings.gradle.kts ====="
          if [ -f settings.gradle.kts ]; then sed -n '1,240p' settings.gradle.kts; else echo "no settings.gradle.kts"; fi

      - name: Debug | list projects & tasks
        shell: bash
        run: |
          set -euo pipefail
          ./gradlew projects --no-daemon
          ./gradlew tasks --all --no-daemon | sed -n '1,200p'

      - name: Build APK (Debug)
        shell: bash
        run: |
          set -euo pipefail
          cd templates/Core-Templates
          chmod +x ./gradlew
          ./gradlew assembleDebug --no-daemon

      - name: Rename APK to user app name (and prepare artifact name)
        shell: bash
        run: |
          set -euo pipefail

          APK_SRC="$(ls -1 templates/Core-Templates/app/build/outputs/apk/debug/*.apk | head -n 1)"
          if [ -z "${APK_SRC:-}" ]; then
            echo "No APK produced at templates/Core-Templates/app/build/outputs/apk/debug/"
            ls -la templates/Core-Templates/app/build/outputs/apk/debug/ || true
            exit 1
          fi

          # 允许中文等 Unicode，只替换 Windows/zip 不允许字符
          SAFE_NAME="$(node -e "
          const a=require('./lib/ndjc/assembly.local.json');
          let s=(a.appName||a.app_label||'NDJC-App').toString().trim();
          s=s.replace(/[\\\\\\/\\:\\*\\?\\\"\\<\\>\\|]/g,'-'); // 禁止字符 -> -
          s=s.replace(/\\s+/g,'-');                            // 空白 -> -
          s=s.replace(/-+/g,'-');                              // 连续 -
          s=s.replace(/^[-\\.]+|[-\\.]+$/g,'');                // 去掉首尾 - .
          if(!s) s='NDJC-App';
          process.stdout.write(s);
          ")"

          OUT_DIR="templates/Core-Templates/app/build/outputs/apk/debug"
          APK_OUT="${OUT_DIR}/${SAFE_NAME}.apk"
          ZIP_OUT="${OUT_DIR}/${SAFE_NAME}.zip"

          cp -f "$APK_SRC" "$APK_OUT"

          # 生成同名 zip：下载 zip 名 = SAFE_NAME.zip；解压后 apk 名 = SAFE_NAME.apk
          (cd "$OUT_DIR" && rm -f "${SAFE_NAME}.zip" && zip -q -j "${SAFE_NAME}.zip" "${SAFE_NAME}.apk")

          echo "NDJC_SAFE_NAME=$SAFE_NAME" >> "$GITHUB_ENV"
          echo "NDJC_APK_OUT=$APK_OUT" >> "$GITHUB_ENV"
          echo "NDJC_ZIP_OUT=$ZIP_OUT" >> "$GITHUB_ENV"

          echo "SAFE_NAME=$SAFE_NAME"
          echo "APK_OUT=$APK_OUT"
          echo "ZIP_OUT=$ZIP_OUT"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.NDJC_SAFE_NAME }}
          path: ${{ env.NDJC_ZIP_OUT }}
          if-no-files-found: error
          retention-days: 14
