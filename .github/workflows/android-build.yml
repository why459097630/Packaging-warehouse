name: Android Build

on:
  workflow_dispatch:
    inputs:
      runId:
        description: "NDJC run id"
        required: false
      template:
        description: "template key (core/simple/form)"
        required: false
      appTitle:
        description: "App title"
        required: false
      packageName:
        description: "Android applicationId"
        required: false

concurrency:
  group: android-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      KS: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fingerprint
        run: |
          echo "HEAD -> $(git rev-parse --short HEAD)"
          echo "RunId: '${{ inputs.runId }}'  Template: '${{ inputs.template }}'  AppTitle: '${{ inputs.appTitle }}'  Pkg: '${{ inputs.packageName }}'"

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Make gradlew executable
        run: |
          test -f ./gradlew || { echo "gradlew not found"; exit 1; }
          chmod +x ./gradlew
          ./gradlew --version

      # ---- 解码 keystore（有密钥才执行） ----
      - name: Decode keystore (optional)
        if: ${{ env.KS != '' }}
        run: |
          echo "${KS}" | base64 -d > "$HOME/release.jks"
          {
            echo "NDJC_KEYSTORE_PATH=$HOME/release.jks"
            echo "NDJC_KEYSTORE_PASSWORD=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}"
            echo "NDJC_KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}"
            echo "NDJC_KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD }}"
          } >> "$GITHUB_ENV"

      # ---- 选择构建类型：有密钥→Release；否则→Debug ----
      - name: Build
        id: build
        shell: bash
        run: |
          set -e
          if [ -z "${KS}" ]; then
            echo "No keystore secrets: build Debug (already signed by debug keystore)"
            ./gradlew :app:clean :app:assembleDebug -x lint --stacktrace
            APK=$(ls -t app/build/outputs/apk/debug/*.apk | head -n1)
            BUILD_VARIANT=debug
          else
            echo "Keystore present: build Release (will be signed by Gradle)"
            ./gradlew :app:clean :app:assembleRelease -x lint --stacktrace
            APK=$(ls -t app/build/outputs/apk/release/*.apk | head -n1)
            BUILD_VARIANT=release
          fi
          echo "apk=$APK" >> "$GITHUB_OUTPUT"
          echo "variant=$BUILD_VARIANT" >> "$GITHUB_OUTPUT"
          ls -lh "$APK"

      # ---- 验签（仅 Release）----
      - name: Verify Release signature
        if: ${{ steps.build.outputs.variant == 'release' }}
        run: |
          "$ANDROID_SDK_ROOT/build-tools/34.0.0/apksigner" verify --verbose --print-certs "${{ steps.build.outputs.apk }}"

      # ---- 提取包信息并写入 Summary ----
      - name: Summarize
        run: |
          P="${{ steps.build.outputs.apk }}"
          APPID=$("$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/apkanalyzer" manifest application-id "$P")
          VC=$("$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/apkanalyzer" manifest version-code "$P")
          VN=$("$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/apkanalyzer" manifest version-name "$P")
          echo "### NDJC Android Build" >> $GITHUB_STEP_SUMMARY
          echo "- Variant: **${{ steps.build.outputs.variant }}**" >> $GITHUB_STEP_SUMMARY
          echo "- Package: \`$APPID\`" >> $GITHUB_STEP_SUMMARY
          echo "- Version: \`$VN\` (code $VC)" >> $GITHUB_STEP_SUMMARY
          echo "- RunId: \`${{ inputs.runId }}\`  Template: \`${{ inputs.template }}\`  AppTitle: \`${{ inputs.appTitle }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Ref: \`${{ github.ref }}\`  Commit: \`$(git rev-parse --short HEAD)\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ steps.build.outputs.variant }}
          path: ${{ steps.build.outputs.apk }}
          if-no-files-found: error
