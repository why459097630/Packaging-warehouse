name: android-build-matrix

on:
  workflow_dispatch:
    inputs:
      template:
        description: "模板目录 (form-template|simple-template|core-template)"
        required: true
        default: form-template
      version:
        description: "版本号"
        required: true
        default: 1.0.0
      apk_name:
        description: "应用名 / APK 名"
        required: true
        default: MyApp
      api_base:
        description: "API Base"
        required: false
        default: ""
      api_secret:
        description: "API Secret"
        required: false
        default: ""

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Ensure gradlew executable
        shell: bash
        run: |
          set -e
          # 统一赋可执行权限，避免 “Permission denied”
          find templates -name gradlew -type f -print0 | xargs -0 chmod +x

      - name: Inject API data into template
        shell: bash
        run: |
          set -e
          ROOT="templates/${{ inputs.template }}/app/src/main"
          VALUES="$ROOT/res/values"
          STRINGS="$VALUES/strings.xml"
          STYLES="$VALUES/styles.xml"

          mkdir -p "$VALUES"

          # 1) 确保 strings.xml 存在且只写入字符串
          if [ ! -f "$STRINGS" ]; then
            cat > "$STRINGS" <<'XML'
<?xml version="1.0" encoding="utf-8"?>
<resources>
</resources>
XML
          fi

          # 去重后再注入，避免 Duplicate resources
          sed -i '/name="app_name"/d'   "$STRINGS"
          sed -i '/name="api_base"/d'   "$STRINGS"
          sed -i '/name="api_secret"/d' "$STRINGS"

          awk -v app="${{ inputs.apk_name }}" \
              -v base="${{ inputs.api_base }}" \
              -v secret="${{ inputs.api_secret }}" '
            /<resources[^>]*>/ && !added {
              print
              print "    <string name=\"app_name\">" app "</string>"
              if (length(base))   print "    <string name=\"api_base\">" base "</string>"
              if (length(secret)) print "    <string name=\"api_secret\">" secret "</string>"
              added=1; next
            }1
          ' "$STRINGS" > "$STRINGS.tmp" && mv "$STRINGS.tmp" "$STRINGS"

          # 2) 确保 styles.xml 里有且仅有一个 AppTheme（绝不往 strings.xml 写样式）
          if [ ! -f "$STYLES" ]; then
            cat > "$STYLES" <<'XML'
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <style name="AppTheme" parent="Theme.MaterialComponents.DayNight.NoActionBar">
        <item name="android:statusBarColor">@android:color/transparent</item>
    </style>
</resources>
XML
          fi

          if ! grep -q 'style name="AppTheme"' "$STYLES"; then
            awk '
              /<\/resources>$/ && !added {
                print "    <style name=\"AppTheme\" parent=\"Theme.MaterialComponents.DayNight.NoActionBar\">"
                print "        <item name=\"android:statusBarColor\">@android:color/transparent</item>"
                print "    </style>"
                added=1
              } {print}
            ' "$STYLES" > "$STYLES.tmp" && mv "$STYLES.tmp" "$STYLES"
          fi

      - name: Build debug APK
        working-directory: templates/${{ inputs.template }}
        run: ./gradlew clean assembleDebug

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.apk_name }}-${{ inputs.version }}-debug
          path: templates/${{ inputs.template }}/app/build/outputs/apk/debug/*.apk
          if-no-files-found: error
