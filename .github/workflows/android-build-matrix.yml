name: Android CI (non-empty-apk with content-pack)

on:
  push:
    branches: [ main ]
    paths:
      - 'content-packs/**'                   # ğŸ‘ˆ API å†™å…¥çš„æ–‡ä»¶ï¼Œpush æ—¶è‡ªåŠ¨è§¦å‘
      - '.github/workflows/android-build-matrix.yml'
      - 'app/**'
      - 'android/**'
      - 'gradle/**'
      - 'build.gradle*'
      - 'settings.gradle*'
  repository_dispatch:
    types: [build-apk]                       # ğŸ‘ˆ API çš„ repository_dispatch äº‹ä»¶
  workflow_dispatch:
    inputs:
      template:
        description: 'template name'
        required: false
      commit_sha:
        description: 'content commit sha'
        required: false

permissions:
  contents: read
  actions: read

concurrency:
  group: android-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      # å…è®¸ä½ é€šè¿‡ workflow_dispatch ä¼ æ¨¡æ¿ï¼›ä¸æ˜¯å¿…é¡»
      TEMPLATE_NAME: ${{ github.event.inputs.template }}
      # äº§ç‰©ä¸Šä¼ çš„åå­—
      ARTIFACT_NAME: apk-output

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Print event & payload
        run: |
          echo "event: ${{ github.event_name }}"
          echo "payload: ${{ toJson(github.event.client_payload) }}"
          ls -la
          ls -la content-packs || true
          test -f content-packs/current.json && cat content-packs/current.json || echo "no content-packs/current.json"

      # Java 17ï¼ˆAndroid Gradle Plugin 8+ æ¨èï¼‰
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # å®‰è£… Android SDKï¼ˆæ›´ç¨³çš„é¢„ç½® Actionï¼Œé¿å…ä½ ä¹‹å‰é‡åˆ°çš„ pipe é”™è¯¯ï¼‰
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      # Gradle ç¼“å­˜
      - name: Gradle cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Ensure gradlew executable
        run: |
          chmod +x ./gradlew || true

      # ===== æ³¨å…¥å†…å®¹åŒ…ï¼ˆå…³é”®ï¼‰=====
      - name: Inject content pack into assets
        shell: bash
        run: |
          set -e
          if [[ -f content-packs/current.json ]]; then
            echo "Found content-packs/current.json"
            # åŸç”Ÿ Android å¸¸è§ç›®å½•
            mkdir -p app/src/main/assets || true
            cp -f content-packs/current.json app/src/main/assets/content.json 2>/dev/null || true

            # React Native å¸¸è§ç›®å½•
            mkdir -p android/app/src/main/assets || true
            cp -f content-packs/current.json android/app/src/main/assets/content.json 2>/dev/null || true

            echo "Content pack copied to assets (if paths exist)."
          else
            echo "::warning::content-packs/current.json not found, build will continue but may produce empty app."
          fi

      # ===== éç©ºæ ¡éªŒï¼Œé¿å…ç©º APK =====
      - name: Pre-build non-empty gate
        shell: bash
        run: |
          set -e
          TARGETS=()
          [[ -f app/src/main/assets/content.json ]] && TARGETS+=("app/src/main/assets/content.json")
          [[ -f android/app/src/main/assets/content.json ]] && TARGETS+=("android/app/src/main/assets/content.json")

          if [[ ${#TARGETS[@]} -eq 0 ]]; then
            echo "::warning::No assets content.json found. Trying to continue, but this likely leads to empty APK."
            exit 0
          fi

          for f in "${TARGETS[@]}"; do
            if [[ ! -s "$f" ]]; then
              echo "::error::$f exists but is empty -> failing to prevent empty APK."
              exit 1
            fi
            echo "OK non-empty: $f"
          done

      # ===== å¯é€‰ï¼šç­¾åï¼ˆå­˜åœ¨æ‰æ‰§è¡Œï¼‰ï¼Œå¦åˆ™èµ° Debug =====
      - name: Decode release keystore (optional)
        if: ${{ secrets.RELEASE_KEYSTORE_BASE64 && secrets.RELEASE_KEYSTORE_PASSWORD && secrets.RELEASE_KEY_ALIAS && secrets.RELEASE_KEY_ALIAS_PASSWORD }}
        shell: bash
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 -d > release.keystore
          ls -la release.keystore

      - name: Build (release if signed; else debug)
        shell: bash
        env:
          # ä¾› Gradle è¯»å–çš„ç­¾åä¿¡æ¯ï¼ˆæŒ‰ä½ å·¥ç¨‹é‡Œ signingConfig çš„å˜é‡å‘½åéœ€è¦ï¼‰
          KEYSTORE_PASSWORD: ${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          KEY_ALIAS_PASSWORD: ${{ secrets.RELEASE_KEY_ALIAS_PASSWORD }}
        run: |
          set -e
          if [[ -f release.keystore ]]; then
            echo "== Building release =="
            # å¦‚æœä½ çš„å·¥ç¨‹é‡Œ signingConfig ä½¿ç”¨çš„æ˜¯ç¯å¢ƒå˜é‡ï¼Œè¿™é‡Œç¡®ä¿ gradle è„šæœ¬èƒ½è¯»åˆ°
            export ANDROID_KEYSTORE=$(pwd)/release.keystore
            ./gradlew --no-daemon assembleRelease
          else
            echo "== No keystore, building debug =="
            ./gradlew --no-daemon assembleDebug
          fi

      - name: Locate APKs
        id: apks
        shell: bash
        run: |
          set -e
          echo "APK list:"
          find . -type f -name "*.apk" -print | tee /tmp/apk-list.txt
          COUNT=$(wc -l </tmp/apk-list.txt | tr -d ' ')
          if [[ "$COUNT" -eq 0 ]]; then
            echo "::error::No APK produced."
            exit 1
          fi
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: |
            **/*.apk
          if-no-files-found: error
