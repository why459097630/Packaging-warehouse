name: Android Build (3 Templates Matrix)

on:
  workflow_dispatch:
    inputs:
      template:
        description: "要构建的模板：core-template / simple-template / form-template / all"
        required: false
        default: "all"
  push:
    paths:
      - "templates/**"
      - ".github/workflows/android-build-matrix.yml"

permissions:
  contents: read

jobs:
  build_matrix:
    name: Build ${{ matrix.template }}
    runs-on: ubuntu-latest

    # 3 个模板的矩阵；如果是手动触发且只想构建其中一个，就用下面的 if 条件筛选
    strategy:
      fail-fast: false
      matrix:
        template: [core-template, simple-template, form-template]

    # 仅当没有指定或指定为 all 时构建全部；否则只构建选择的那个
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.template == 'all' || inputs.template == '' || matrix.template == inputs.template }}

    env:
      TEMPLATE_DIR: templates/${{ matrix.template }}
      APP_DIR: templates/${{ matrix.template }}/app

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew
        working-directory: ${{ env.TEMPLATE_DIR }}

      - name: Build Release APK
        run: ./gradlew --no-daemon assembleRelease
        working-directory: ${{ env.TEMPLATE_DIR }}

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-${{ matrix.template }}.apk
          path: |
            ${{ env.TEMPLATE_DIR }}/app/build/outputs/apk/release/*.apk
            ${{ env.TEMPLATE_DIR }}/app/build/outputs/apk/*/*.apk
          if-no-files-found: warn
