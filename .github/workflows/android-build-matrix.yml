name: Android Build (matrix)

on:
  workflow_dispatch:
    inputs:
      template:
        description: "模板（core-template|form-template|simple-template）"
        required: true
        type: string
      prompt:
        description: "应用描述 / prompt"
        required: true
        type: string
      owner:
        description: "目标仓库 owner（写入生成代码的仓库）"
        required: true
        type: string
      repo:
        description: "目标仓库 repo"
        required: true
        type: string
      branch:
        description: "目标分支"
        required: false
        default: "main"
        type: string
      apk_name:
        description: "APK 文件名"
        required: false
        default: "app"
        type: string
      version_name:
        description: "版本名"
        required: false
        default: "1.0.0"
        type: string
      version_code:
        description: "版本号（整数）"
        required: false
        default: "1"
        type: string
      reason:                # ← 关键：把 reason 声明出来，避免 422
        description: "触发原因/追踪标识（可选）"
        required: false
        type: string

permissions:
  contents: read

jobs:
  build:
    name: Build Android
    runs-on: ubuntu-latest

    env:
      TEMPLATE:      ${{ inputs.template }}
      PROMPT:        ${{ inputs.prompt }}
      GH_OWNER:      ${{ inputs.owner }}
      GH_REPO:       ${{ inputs.repo }}
      GH_BRANCH:     ${{ inputs.branch }}
      APK_NAME:      ${{ inputs.apk_name }}
      VERSION_NAME:  ${{ inputs.version_name }}
      VERSION_CODE:  ${{ inputs.version_code }}
      REASON:        ${{ inputs.reason }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: 'gradle'

      - name: Print inputs (for debugging)
        run: |
          echo "TEMPLATE=$TEMPLATE"
          echo "PROMPT=$PROMPT"
          echo "GH_OWNER=$GH_OWNER GH_REPO=$GH_REPO GH_BRANCH=$GH_BRANCH"
          echo "APK_NAME=$APK_NAME VERSION_NAME=$VERSION_NAME VERSION_CODE=$VERSION_CODE"
          echo "REASON=$REASON"

      # ======（可选）生成/写入模板代码的步骤，如果你的仓库里已经完成这一步，可自行删除 ======
      # - name: Generate project code from template
      #   run: |
      #     # 在这里把 $TEMPLATE / $PROMPT 等参数写入到 app 源码
      #     echo "Generate code here..."
      # ======================================================================

      # 有签名时：解码 keystore 并写入环境变量
      - name: Decode release keystore
        if: ${{ secrets.RELEASE_KEYSTORE_BASE64 && secrets.RELEASE_KEYSTORE_PASSWORD && secrets.RELEASE_KEY_ALIAS && secrets.RELEASE_KEY_ALIAS_PASSWORD }}
        run: |
          mkdir -p app
          echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 -d > app/release.jks
          echo "STORE_FILE=app/release.jks" >> $GITHUB_ENV
          echo "STORE_PASSWORD=${{ secrets.RELEASE_KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.RELEASE_KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.RELEASE_KEY_ALIAS_PASSWORD }}" >> $GITHUB_ENV

      # 有签名：打 release 包
      - name: Build release
        if: ${{ secrets.RELEASE_KEYSTORE_BASE64 && secrets.RELEASE_KEYSTORE_PASSWORD && secrets.RELEASE_KEY_ALIAS && secrets.RELEASE_KEY_ALIAS_PASSWORD }}
        run: |
          ./gradlew --no-daemon clean :app:assembleRelease \
            -PversionName="${VERSION_NAME}" -PversionCode="${VERSION_CODE}"

      - name: Upload release APK
        if: ${{ secrets.RELEASE_KEYSTORE_BASE64 && secrets.RELEASE_KEYSTORE_PASSWORD && secrets.RELEASE_KEY_ALIAS && secrets.RELEASE_KEY_ALIAS_PASSWORD }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APK_NAME }}-release
          path: app/build/outputs/apk/release/*.apk
          if-no-files-found: warn

      # 无签名：fallback 到 debug 包
      - name: Build debug (fallback)
        if: ${{ !(secrets.RELEASE_KEYSTORE_BASE64 && secrets.RELEASE_KEYSTORE_PASSWORD && secrets.RELEASE_KEY_ALIAS && secrets.RELEASE_KEY_ALIAS_PASSWORD) }}
        run: |
          ./gradlew --no-daemon clean :app:assembleDebug \
            -PversionName="${VERSION_NAME}" -PversionCode="${VERSION_CODE}"

      - name: Upload debug APK
        if: ${{ !(secrets.RELEASE_KEYSTORE_BASE64 && secrets.RELEASE_KEYSTORE_PASSWORD && secrets.RELEASE_KEY_ALIAS && secrets.RELEASE_KEY_ALIAS_PASSWORD) }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APK_NAME }}-debug
          path: app/build/outputs/apk/debug/*.apk
          if-no-files-found: warn
