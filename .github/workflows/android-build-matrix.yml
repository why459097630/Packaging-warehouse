name: Android Build (3 Templates Matrix)

on:
  # 手动触发（给前端/后台调用）
  workflow_dispatch:
    inputs:
      template:
        description: Which template to build
        type: choice
        options: [core-template, simple-template, form-template]
        default: core-template
        required: true
      build_type:
        description: Build type
        type: choice
        options: [debug, release]
        default: debug
        required: true

  # 推送到 main 时，仍然走三模板矩阵构建
  push:
    branches: [ main ]

jobs:
  # A. 手动触发：只构建一个模板（给你的前端/后台用）
  build_single:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Clean app dir
        run: rm -rf app

      - name: Use selected template
        run: cp -a templates/${{ inputs.template }}/app ./app

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Choose task
        id: task
        run: |
          if [ "${{ inputs.build_type }}" = "release" ]; then
            echo "TASK=assembleRelease" >> $GITHUB_OUTPUT
          else
            echo "TASK=assembleDebug" >> $GITHUB_OUTPUT
          fi

      - name: Build APK
        run: ./gradlew --no-daemon ${{ steps.task.outputs.TASK }}

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ inputs.build_type }}-${{ inputs.template }}
          path: app/build/outputs/apk/**/${{ inputs.build_type }}/*.apk
          if-no-files-found: error

  # B. push 触发：三模板矩阵照常跑（便于你自己回归）
  build_matrix:
    if: ${{ github.event_name != 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        template: [core-template, simple-template, form-template]
    steps:
      - uses: actions/checkout@v4

      - name: Clean app dir
        run: rm -rf app

      - name: Use selected template
        run: cp -a templates/${{ matrix.template }}/app ./app

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 矩阵默认用 debug，够装机验证；你也可改成 release
      - name: Build APK
        run: ./gradlew --no-daemon assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-${{ matrix.template }}
          path: app/build/outputs/apk/**/debug/*.apk
          if-no-files-found: error
