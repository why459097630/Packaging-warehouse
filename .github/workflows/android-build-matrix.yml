name: Android Build (3 Templates Matrix)

on:
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.template }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        template: [core-template, simple-template, form-template]

    defaults:
      run:
        working-directory: templates/${{ matrix.template }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Make gradlew executable
        run: chmod +x ./gradlew || true

      - name: Ensure gradle.properties
        run: |
          touch gradle.properties
          grep -q '^android.useAndroidX=true' gradle.properties || echo 'android.useAndroidX=true' >> gradle.properties
          grep -q '^android.enableJetifier=true' gradle.properties || echo 'android.enableJetifier=true' >> gradle.properties

      # 这里去掉 if:，在脚本里判断是否为空
      - name: Decode keystore
        env:
          KS_B64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          if [ -n "$KS_B64" ]; then
            echo "$KS_B64" | base64 -d > keystore.jks
            ls -l keystore.jks
          else
            echo "ANDROID_KEYSTORE_BASE64 is empty. Skip decoding."
          fi

      - name: Build release (unsigned)
        run: ./gradlew --no-daemon assembleRelease

      - name: Locate unsigned APK
        id: apk
        run: |
          APK=$(ls app/build/outputs/apk/release/*-unsigned.apk | head -n1)
          echo "unsigned=$APK" >> $GITHUB_OUTPUT
          OUT="app-release-${{ matrix.template }}.apk"
          echo "signed=$OUT" >> $GITHUB_OUTPUT
          echo "unsigned_abs=$PWD/$APK" >> $GITHUB_OUTPUT
          echo "signed_abs=$PWD/$OUT" >> $GITHUB_OUTPUT
          echo "Found unsigned: $APK -> $OUT"

      - name: Sign APK
        env:
          STORE_PWD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_PWD:   ${{ secrets.ANDROID_KEY_PASSWORD }}
          ALIAS:     ${{ secrets.ANDROID_KEY_ALIAS }}
        run: |
          set -e
          SDK=${ANDROID_SDK_ROOT:-$ANDROID_HOME}
          BT_VER=$(ls -1 "$SDK/build-tools" | sort -V | tail -n1)
          A_SIGNER="$SDK/build-tools/$BT_VER/apksigner"

          # 如果没有 keystore（比如没配置 secret），就直接报错退出
          if [ ! -f keystore.jks ]; then
            echo "keystore.jks not found. Please set ANDROID_KEYSTORE_BASE64 secret."
            exit 1
          fi

          "$A_SIGNER" sign \
            --ks keystore.jks \
            --ks-pass "pass:$STORE_PWD" \
            --key-pass "pass:$KEY_PWD" \
            --ks-key-alias "$ALIAS" \
            --out "${{ steps.apk.outputs.signed }}" \
            "${{ steps.apk.outputs.unsigned }}"

          "$A_SIGNER" verify --verbose "${{ steps.apk.outputs.signed }}"

      - name: Upload signed APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-${{ matrix.template }}.apk
          path: ${{ steps.apk.outputs.signed_abs }}
          if-no-files-found: error
