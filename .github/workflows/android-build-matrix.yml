name: Android CI (non-empty-apk with content-pack)

on:
  push:
    branches: [ main ]
    paths:
      - 'content-packs/**'
      - '.github/workflows/android-build-matrix.yml'
      - 'app/**'
      - 'android/**'
      - 'gradle/**'
      - 'build.gradle*'
      - 'settings.gradle*'
  repository_dispatch:
    types: [build-apk]
  workflow_dispatch:
    inputs:
      template:
        description: 'template name (optional)'
        required: false
      commit_sha:
        description: 'content commit sha (optional)'
        required: false

permissions:
  contents: read
  actions: read

concurrency:
  group: android-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      ARTIFACT_NAME: apk-output

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Print event & list repo
        run: |
          echo "event: ${{ github.event_name }}"
          echo "payload: ${{ toJson(github.event.client_payload) }}"
          ls -la
          ls -la content-packs || true
          test -f content-packs/current.json && head -c 200 content-packs/current.json || echo "no content-packs/current.json"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Gradle cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Ensure gradlew executable
        run: chmod +x ./gradlew || true

      # === 注入内容包到 assets（支持两种常见工程结构）===
      - name: Inject content pack into assets
        shell: bash
        run: |
          set -e
          if [[ -f content-packs/current.json ]]; then
            echo "Found content-packs/current.json"
            mkdir -p app/src/main/assets || true
            cp -f content-packs/current.json app/src/main/assets/content.json 2>/dev/null || true

            mkdir -p android/app/src/main/assets || true
            cp -f content-packs/current.json android/app/src/main/assets/content.json 2>/dev/null || true

            echo "Content pack copied to assets (if paths exist)."
          else
            echo "::warning::content-packs/current.json not found, build may produce empty APK."
          fi

      # === 非空闸门，避免空 APK ===
      - name: Pre-build non-empty gate
        shell: bash
        run: |
          set -e
          TARGETS=()
          [[ -f app/src/main/assets/content.json ]] && TARGETS+=("app/src/main/assets/content.json")
          [[ -f android/app/src/main/assets/content.json ]] && TARGETS+=("android/app/src/main/assets/content.json")

          if [[ ${#TARGETS[@]} -eq 0 ]]; then
            echo "::warning::No assets content.json found. Trying to continue, but this likely leads to empty APK."
            exit 0
          fi

          for f in "${TARGETS[@]}"; do
            if [[ ! -s "$f" ]]; then
              echo "::error::$f exists but is empty -> failing to prevent empty APK."
              exit 1
            fi
            echo "OK non-empty: $f"
          done

      # === 先检查是否提供了签名 secrets，输出一个布尔结果 ===
      - name: Check signing secrets
        id: signing
        shell: bash
        env:
          KS_B64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}
          KS_PWD: ${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
          ALIAS:  ${{ secrets.RELEASE_KEY_ALIAS }}
          ALIAS_PWD: ${{ secrets.RELEASE_KEY_ALIAS_PASSWORD }}
        run: |
          has_signing=false
          if [[ -n "$KS_B64" && -n "$KS_PWD" && -n "$ALIAS" && -n "$ALIAS_PWD" ]]; then
            has_signing=true
          fi
          echo "has_signing=$has_signing" >> "$GITHUB_OUTPUT"
          echo "has_signing=$has_signing"

      - name: Decode release keystore
        if: ${{ steps.signing.outputs.has_signing == 'true' }}
        shell: bash
        env:
          KS_B64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}
        run: |
          echo "$KS_B64" | base64 -d > release.keystore
          ls -la release.keystore

      # === 分开两个构建步骤：release 与 debug，按上一步判断 ===
      - name: Build release
        if: ${{ steps.signing.outputs.has_signing == 'true' }}
        shell: bash
        env:
          KEYSTORE_PASSWORD:     ${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
          KEY_ALIAS:             ${{ secrets.RELEASE_KEY_ALIAS }}
          KEY_ALIAS_PASSWORD:    ${{ secrets.RELEASE_KEY_ALIAS_PASSWORD }}
          ANDROID_KEYSTORE:      ${{ github.workspace }}/release.keystore
        run: |
          set -e
          ./gradlew --no-daemon assembleRelease

      - name: Build debug (fallback)
        if: ${{ steps.signing.outputs.has_signing != 'true' }}
        shell: bash
        run: |
          set -e
          ./gradlew --no-daemon assembleDebug

      - name: Locate APKs
        id: apks
        shell: bash
        run: |
          set -e
          echo "APK list:"
          find . -type f -name "*.apk" -print | tee /tmp/apk-list.txt
          COUNT=$(wc -l </tmp/apk-list.txt | tr -d ' ')
          if [[ "$COUNT" -eq 0 ]]; then
            echo "::error::No APK produced."
            exit 1
          fi
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: |
            **/*.apk
          if-no-files-found: error
