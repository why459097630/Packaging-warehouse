name: Android Build (3 Templates Matrix)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        template: [simple-template, core-template, form-template]

    steps:
      - name: Checkout Packaging repo
        uses: actions/checkout@v4

      - name: Checkout safe-templates
        uses: actions/checkout@v4
        with:
          repository: why459097630/safe-templates
          path: safe-templates

      - name: Clean old app
        run: |
          rm -rf app
          mkdir -p app

      # 关键：拷贝模板到 app/
      - name: Copy template to app
        run: cp -r "safe-templates/${{ matrix.template }}/app/." ./app/

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x ./app/gradlew

      # 构建 APK
      - name: Build APK
        working-directory: app
        run: ./gradlew assembleRelease

      # 生成 upload 目录，并加 commit SHA 到文件名
      - name: Prepare APK for upload
        run: |
          mkdir -p upload
          cp app/build/outputs/apk/release/app-release.apk upload/app-release-${GITHUB_SHA}.apk

      # 上传 artifact，artifact 名也带 SHA
      - name: Upload APK artifact
        uses: actions/upload-artifact@v3
        with:
          name: app-release-${{ github.sha }}
          path: upload/*.apk
