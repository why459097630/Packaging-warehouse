name: Android Build (ndjc_apply)

on:
  repository_dispatch:
    types: [ndjc_apply]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Fix gradlew permission
        run: chmod +x ./gradlew

      - name: Show triggering event and payload
        run: |
          echo "event=$GITHUB_EVENT_NAME"
          echo "ref=$GITHUB_REF"
          echo "sha=$GITHUB_SHA"
          echo "payload:" && cat "$GITHUB_EVENT_PATH" || true

      # 构建：高日志 & 保存控制台输出
      - name: Build release (with console log)
        run: |
          set -o pipefail
          ./gradlew --version
          ./gradlew clean :app:assembleRelease \
            --no-daemon --stacktrace -i --warning-mode all | tee gradle-console.log

      - name: Upload APK artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: app/build/outputs/apk/release/*.apk
          if-no-files-found: warn

      # ===== 失败时诊断输出 =====
      - name: Grep AAPT2 errors (on failure)
        if: failure()
        run: |
          echo "---- AAPT2 errors ----"
          grep -RIn "Android resource linking failed" app/build || true
          grep -RIn "^error:" app/build/outputs || true
          grep -RIn "AAPT: error" app/build || true

      - name: Grep Java compile errors (on failure)
        if: failure()
        run: |
          echo "---- JAVAC errors ----"
          grep -RIn "cannot find symbol" app/build || true
          grep -RIn "symbol:" app/build || true
          grep -RIn "\.java:[0-9]\+:" gradle-console.log || true
          tail -n 200 gradle-console.log || true
          echo "---- END ----"

      # 额外：对比 Java 里用到的 R.id 与布局里定义的 id，直接列出缺失项
      - name: Diff resource IDs (on failure)
        if: failure()
        shell: bash
        run: |
          echo "---- Referenced IDs in Java ----"
          mkdir -p /tmp
          grep -Rho "R\.id\.[A-Za-z0-9_]\+" app/src/main/java || true \
            | sed 's/.*R\.id\.//' | sort -u > /tmp/java_ids.txt || true
          cat /tmp/java_ids.txt || true
          echo "---- IDs defined in layouts ----"
          grep -Rho "@\+id/[A-Za-z0-9_]\+" app/src/main/res/layout || true \
            | sed 's/@+id\///' | sort -u > /tmp/layout_ids.txt || true
          cat /tmp/layout_ids.txt || true
          echo "---- Missing (referenced but not defined) ----"
          if [ -s /tmp/java_ids.txt ]; then
            comm -23 /tmp/java_ids.txt /tmp/layout_ids.txt || true
          else
            echo "(no R.id.* referenced under app/src/main/java)"
          fi

      - name: Upload build logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: app-build-logs
          path: |
            gradle-console.log
            app/build/outputs/
            app/build/reports/
            **/*.log
            **/*.txt
