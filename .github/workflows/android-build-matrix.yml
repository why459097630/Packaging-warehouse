name: android-build-matrix

on:
  workflow_dispatch:
    inputs:
      template:       { description: 'template dir', required: true,  default: 'form-template' }
      prompt:         { description: 'prompt text',  required: true,  default: '' }
      owner:          { description: 'repo owner',   required: true,  default: 'why459097630' }
      repo:           { description: 'repo name',    required: true,  default: 'Packaging-warehouse' }
      branch:         { description: 'branch',       required: true,  default: 'main' }
      apk_name:       { description: 'APK name',     required: true,  default: 'MyApp' }
      version_name:   { description: 'versionName',  required: true,  default: '1.0.0' }
      version_code:   { description: 'versionCode',  required: true,  default: '1' }
      reason:         { description: 'reason',       required: false, default: '' }

jobs:
  build:
    runs-on: ubuntu-latest

    # 把 inputs 和 secrets 全部映射到 env，if 只用 env 判断
    env:
      TEMPLATE:      ${{ inputs.template }}
      PROMPT:        ${{ inputs.prompt }}
      OWNER:         ${{ inputs.owner }}
      REPO:          ${{ inputs.repo }}
      BRANCH:        ${{ inputs.branch }}
      APK_NAME:      ${{ inputs.apk_name }}
      VERSION_NAME:  ${{ inputs.version_name }}
      VERSION_CODE:  ${{ inputs.version_code }}
      REASON:        ${{ inputs.reason }}

      RELEASE_KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}
      RELEASE_STORE_PASSWORD:  ${{ secrets.RELEASE_STORE_PASSWORD }}
      RELEASE_KEY_ALIAS:       ${{ secrets.RELEASE_KEY_ALIAS }}
      RELEASE_KEY_PASSWORD:    ${{ secrets.RELEASE_KEY_PASSWORD }}

      # 统一在 env 里生成一个布尔字符串，后面直接用它做 if 判断
      HAS_SIGNING: ${{ (secrets.RELEASE_KEYSTORE_BASE64 != '' &&
                        secrets.RELEASE_STORE_PASSWORD  != '' &&
                        secrets.RELEASE_KEY_ALIAS       != '' &&
                        secrets.RELEASE_KEY_PASSWORD    != '') }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Generate project from template
        run: |
          echo "template=$TEMPLATE"
          echo "prompt=$PROMPT"
          # 这里调用你生成模板与写入逻辑的脚本 / 命令
          # bash scripts/generate_from_template.sh "$TEMPLATE" "$PROMPT" "$APK_NAME" "$VERSION_NAME" "$VERSION_CODE"

      # ----------------- 有签名：release -----------------
      - name: Decode release keystore
        if: ${{ env.HAS_SIGNING == 'true' }}
        run: |
          echo "${RELEASE_KEYSTORE_BASE64}" | base64 -d > keystore.jks

      - name: Build release (signed)
        if: ${{ env.HAS_SIGNING == 'true' }}
        run: |
          ./gradlew clean assembleRelease \
            -Pandroid.injected.signing.store.file=$GITHUB_WORKSPACE/keystore.jks \
            -Pandroid.injected.signing.store.password="${RELEASE_STORE_PASSWORD}" \
            -Pandroid.injected.signing.key.alias="${RELEASE_KEY_ALIAS}" \
            -Pandroid.injected.signing.key.password="${RELEASE_KEY_PASSWORD}"

      # ----------------- 无签名：debug -----------------
      - name: Build debug (fallback)
        if: ${{ env.HAS_SIGNING != 'true' }}
        run: ./gradlew clean assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APK_NAME }}-${{ env.VERSION_NAME }}-apk
          path: |
            **/app/build/outputs/apk/**/**/*.apk
            **/build/outputs/apk/**/**/*.apk
