name: Android Build (3 Templates Matrix)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    name: build (${{ matrix.template }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        template: [simple-template, core-template, form-template]

    steps:
      - name: Checkout Packaging repo
        uses: actions/checkout@v4

      - name: Checkout safe-templates
        uses: actions/checkout@v4
        with:
          repository: why459097630/safe-templates
          path: safe-templates

      # 可视化/调试：看看模板目录里有什么
      - name: Show template structure (debug)
        run: |
          ls -la
          echo "----"
          ls -la safe-templates/${{ matrix.template }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Android SDK (cmdline-tools)
        uses: android-actions/setup-android@v3

      - name: Install required SDK components
        shell: bash
        run: |
          set -e
          yes | sdkmanager --licenses >/dev/null
          sdkmanager "platform-tools" \
                     "platforms;android-34" \
                     "build-tools;34.0.0"

      # 采用 Gradle 官方 Action；如果模板里没有 gradlew 也能工作（会下发临时 Gradle）
      - name: Build with Gradle (assembleRelease)
        uses: gradle/gradle-build-action@v3
        with:
          build-root-directory: safe-templates/${{ matrix.template }}
          arguments: assembleRelease
          gradle-version: 8.7

      - name: Collect APKs
        id: collect
        shell: bash
        working-directory: safe-templates/${{ matrix.template }}
        run: |
          set -e
          # 常规 Android 工程，release APK 在 app 模块下：
          find app/build/outputs -type f -name "*.apk" | sed 's/^/APK: /'
          echo "apk_glob=app/build/outputs/**/*.apk" >> $GITHUB_OUTPUT

      - name: Upload artifact (${{ matrix.template }})
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.template }}-apk-${{ github.sha }}
          path: safe-templates/${{ matrix.template }}/${{ steps.collect.outputs.apk_glob }}
          if-no-files-found: error
