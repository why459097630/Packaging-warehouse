name: Android CI Matrix

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        api-level: [30]
        target: [default]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Gradle Build
        run: ./gradlew --stacktrace --no-daemon assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: app/build/outputs/apk/debug/*.apk
          if-no-files-found: error
          retention-days: 7

      - name: Emulator smoke run (15s crash monitor)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          arch: x86_64
          profile: pixel_5
          disable-animations: true
          script: |
            APK_PATH="$(find app/build/outputs/apk/debug -maxdepth 1 -type f -name '*.apk' | head -n 1)"; [ -n "$APK_PATH" ] || { echo "No APK under app/build/outputs/apk/debug"; find app/build/outputs -type f -name '*.apk' -print || true; exit 1; }; echo "Found APK: $APK_PATH"; adb install -r "$APK_PATH" >/dev/null; command -v aapt >/dev/null 2>&1 || { sdkmanager --install "build-tools;34.0.0"; export PATH="$ANDROID_HOME/build-tools/34.0.0:$PATH"; }; PKG="$(aapt dump badging "$APK_PATH" | awk -F\" '/package: name=/{print $2}')"; ACT="$(aapt dump badging "$APK_PATH" | awk -F\" '/launchable-activity: name=/{print $2}')"; echo "Detected package: $PKG"; echo "Detected launcher: $ACT"; adb logcat -c; adb shell am start -n "${PKG}/${ACT}"; timeout 15s sh -c 'adb logcat | tee /tmp/logcat.txt | grep -q -E "FATAL EXCEPTION|Process[[:space:]].*'"$PKG"'[[:space:]].*has died"'; RES=$?; [ "$RES" -eq 0 ] && { echo "Crash detected during smoke run:"; tail -n 200 /tmp/logcat.txt || true; exit 1; } || echo "Smoke run passed (no fatal crash in 15s)."
