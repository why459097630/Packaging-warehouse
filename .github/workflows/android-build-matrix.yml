# .github/workflows/android-build-matrix.yml
name: Android Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Grant gradlew execute permission
        run: chmod +x ./gradlew

      # ✅ 写 keystore 到 app/release.keystore（用 printf 防止多换行）
      - name: Write release keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          mkdir -p app
          printf "%s" "$ANDROID_KEYSTORE_BASE64" | base64 -d > app/release.keystore
          chmod 600 app/release.keystore
          echo "---- keystore info ----"
          ls -l app/release.keystore || true
          file app/release.keystore || true

      # ✅ 导出签名环境变量（Gradle 会读取）
      - name: Export signing env
        run: |
          echo "ANDROID_KEYSTORE_FILE=$GITHUB_WORKSPACE/app/release.keystore" >> $GITHUB_ENV
          echo "ANDROID_KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}" >> $GITHUB_ENV
          echo "ANDROID_KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD }}" >> $GITHUB_ENV
          echo "ANDROID_KEYSTORE_PASSWORD=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> $GITHUB_ENV

      - name: Build release
        run: ./gradlew clean :app:assembleRelease --stacktrace

      - name: Upload release APK
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-release.apk
          path: app/build/outputs/apk/release/app-release.apk

      - name: Upload build logs (always)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: app-build-logs
          path: |
            **/*.log
            app/build/outputs/**/*.txt
