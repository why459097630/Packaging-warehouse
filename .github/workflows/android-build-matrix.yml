name: Android Build (NDJC)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      # 安装 cmdline-tools 并正确放到 latest/ 目录
      - name: Install Android Commandline Tools
        run: |
          set -euxo pipefail
          export ANDROID_SDK_ROOT="$HOME/android-sdk"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          curl -fsSL https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -o /tmp/cmdtools.zip
          unzip -q /tmp/cmdtools.zip -d /tmp
          # 解压后得到 /tmp/cmdline-tools/{bin,lib,...}，将“整个目录”移动到 latest/
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/latest"
          mv /tmp/cmdline-tools "$ANDROID_SDK_ROOT/cmdline-tools/latest"
          # 追加 PATH：latest/bin 才有 sdkmanager
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/platform-tools"           >> $GITHUB_PATH

      # 用绝对路径调用 sdkmanager，并带诊断与校验
      - name: Install Android SDK packages (34 / 34.0.0)
        run: |
          set -euxo pipefail
          echo "ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT:-<unset>}"
          ls -la "$ANDROID_SDK_ROOT" || true
          ls -la "$ANDROID_SDK_ROOT/cmdline-tools" || true
          ls -la "$ANDROID_SDK_ROOT/cmdline-tools/latest" || true
          ls -la "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" || true

          SDKMGR="$ANDROID_SDK_ROOT/cmdline-tools/latest/cmdline-tools/bin/sdkmanager"
          # 兼容有些包的目录结构（latest/bin/sdkmanager）
          if [ ! -x "$SDKMGR" ]; then
            SDKMGR="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          fi
          if [ ! -x "$SDKMGR" ]; then
            echo "FATAL: sdkmanager not found under $ANDROID_SDK_ROOT/cmdline-tools/latest/"
            exit 127
          fi

          "$SDKMGR" --version
          yes | "$SDKMGR" --licenses
          yes | "$SDKMGR" "platform-tools" "platforms;android-34" "build-tools;34.0.0"

          # 安装结果校验
          test -d "$ANDROID_SDK_ROOT/platforms/android-34" || (echo "platforms;android-34 missing" && exit 2)
          test -d "$ANDROID_SDK_ROOT/build-tools/34.0.0"    || (echo "build-tools;34.0.0 missing" && exit 2)

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: gradle-${{ runner.os }}

      - name: Build
        run: |
          chmod +x ./gradlew
          ./gradlew --no-daemon assembleRelease

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ndjc-apk
          path: app/build/outputs/apk/release/*.apk
          if-no-files-found: error
