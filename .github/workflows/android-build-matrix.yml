name: Android CI (robust + no-empty-apk)

on:
  push:
    branches: [ main ]
    paths:
      - 'app/**'
      - 'templates/**'
      - '.github/workflows/android-build-matrix.yml'
  workflow_dispatch:
    inputs:
      template:
        description: "Override template (core-template|form-template|simple-template)"
        required: false
        default: ""
      minApkSizeKB:
        description: "Fail if release APK size < this KB"
        required: false
        default: "100"

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      JAVA_VERSION: '17'
      MIN_APK_KB: ${{ inputs.minApkSizeKB || '100' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # =========================
      # 1) 解析模板（更鲁棒，带默认回退）
      # =========================
      - name: Determine template from marker (robust with fallback)
        id: pick
        shell: bash
        run: |
          set -euo pipefail

          # 1) workflow_dispatch 覆盖
          if [[ -n "${{ inputs.template }}" ]]; then
            tmpl="${{ inputs.template }}"
          else
            # 2) 先在 assets 下找各种 marker / 文本
            tmpl="$(grep -Eroh '(core-template|form-template|simple-template)' app/src/main/assets 2>/dev/null | head -n1 || true)"
            # 3) 仓库兜底全局 grep（避免路径不同或文件名随机）
            if [[ -z "${tmpl:-}" ]]; then
              tmpl="$(git grep -Eo '(core-template|form-template|simple-template)' -- '**/*.txt' ':/app' 2>/dev/null | head -n1 | awk '{print $1}' || true)"
            fi
            # 4) 仍未找到 -> 默认回退 form-template，给出 warning
            if [[ -z "${tmpl:-}" ]]; then
              echo "::warning ::No template found in markers, fallback to 'form-template'"
              tmpl="form-template"
            fi
          fi

          # 校验
          case "$tmpl" in
            core-template|form-template|simple-template) ;;
            *) echo "::warning ::Template '$tmpl' not in {core-template|form-template|simple-template}, fallback to 'form-template'"; tmpl="form-template" ;;
          esac

          echo "template=$tmpl" >> "$GITHUB_OUTPUT"
          echo "Template resolved: $tmpl"

      # =========================
      # 2) 应用模板到 app/（只覆盖 app 模块）
      # =========================
      - name: Apply template to app/
        shell: bash
        run: |
          set -euo pipefail
          tmpl="${{ steps.pick.outputs.template }}"
          src="templates/${tmpl}/app"
          dst="app"

          if [[ ! -d "$src" ]]; then
            echo "::error::Template path not found: $src"
            exit 1
          fi

          echo "Cleaning ${dst}/src/main ..."
          rm -rf "${dst:?}/src/main"
          mkdir -p "${dst}/src"

          echo "Copy ${src}/src/main -> ${dst}/src/main"
          rsync -a --delete "${src}/src/main/" "${dst}/src/main/"

          # 若模板中包含 app 级别的构建脚本，按需覆盖
          if [[ -f "${src}/build.gradle" ]]; then
            cp -f "${src}/build.gradle" "${dst}/build.gradle"
          fi
          if [[ -f "${src}/build.gradle.kts" ]]; then
            cp -f "${src}/build.gradle.kts" "${dst}/build.gradle.kts"
          fi

      # =========================
      # 3) 编译前显式校验（防空包第一道闸）
      # =========================
      - name: Validate module is not empty (fail-fast)
        shell: bash
        run: |
          set -euo pipefail

          test -f app/src/main/AndroidManifest.xml || { echo "::error::Missing AndroidManifest.xml"; exit 1; }

          src_count=$(find app/src/main/java app/src/main/kotlin -type f \( -name '*.kt' -o -name '*.java' \) 2>/dev/null | wc -l | xargs)
          if [[ "${src_count:-0}" -lt 1 ]]; then
            echo "::error::No source files under app/src/main/java|kotlin"
            exit 1
          fi

          res_count=$(find app/src/main/res -type f 2>/dev/null | wc -l | xargs)
          if [[ "${res_count:-0}" -lt 1 ]]; then
            echo "::error::No resources under app/src/main/res"
            exit 1
          fi

      # =========================
      # 4) 可选：修补 namespace，避免默认包名
      # =========================
      - name: Patch Gradle namespace (optional)
        shell: bash
        run: |
          set -euo pipefail
          owner="${GITHUB_REPOSITORY_OWNER,,}"
          repo="${GITHUB_REPOSITORY##*/}"; repo="${repo,,}"
          ns="com.${owner//[^a-z0-9]/}.app.${repo//[^a-z0-9]/}"

          if [[ -f app/build.gradle ]]; then
            sed -i -E "s/namespace\\s*=\\s*\"[^\"]+\"/namespace \"$ns\"/g" app/build.gradle || true
          fi
          if [[ -f app/build.gradle.kts ]]; then
            sed -i -E "s/namespace\\s*=\\s*\"[^\"]+\"/namespace = \"$ns\"/g" app/build.gradle.kts || true
          fi

          if grep -q 'package="com.example' app/src/main/AndroidManifest.xml 2>/dev/null; then
            sed -i -E "s/package=\"[^\"]+\"/package=\"$ns\"/g" app/src/main/AndroidManifest.xml || true
          fi

          echo "Namespace set to: $ns"

      # =========================
      # 5) 编译（unsigned）
      # =========================
      - name: Build (unsigned)
        run: ./gradlew --no-daemon clean :app:assembleRelease

      # =========================
      # 6) 产物体积校验（防空包第二道闸）
      # =========================
      - name: Verify release APK exists and size
        id: apkcheck
        shell: bash
        run: |
          set -euo pipefail
          APK=$(ls -1 app/build/outputs/apk/release/*.apk 2>/dev/null | head -n1 || true)
          if [[ -z "${APK}" ]]; then
            echo "::error::No release APK produced under app/build/outputs/apk/release"
            exit 1
          fi
          size_kb=$(( $(stat -c%s "$APK") / 1024 ))
          echo "apk=$APK" >> "$GITHUB_OUTPUT"
          echo "size_kb=$size_kb" >> "$GITHUB_OUTPUT"
          echo "APK: $APK ($size_kb KB)"

          min_kb="${{ env.MIN_APK_KB }}"
          if [[ "${size_kb}" -lt "${min_kb}" ]]; then
            echo "::error::APK too small (${size_kb}KB < ${min_kb}KB). Failing to prevent empty APK."
            exit 1
          fi

      - name: Upload unsigned APK
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-release-apk
          path: ${{ steps.apkcheck.outputs.apk }}
          if-no-files-found: error
