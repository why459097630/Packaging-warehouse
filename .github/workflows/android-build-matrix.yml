name: Android Build & Zero-Crash Gate

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # 统一换行符，避免脚本在 Linux 下因 CRLF 触发语法问题
      - name: Normalize line endings to LF (optional but recommended)
        run: |
          sudo apt-get update && sudo apt-get install -y dos2unix
          dos2unix .github/workflows/* || true
          find scripts -type f -exec dos2unix {} \; || true

      # ==== 生成代码存在性校验（缺任一关键文件直接 fail） ====
      - name: Make scripts executable
        run: chmod +x scripts/check-generated.sh

      - name: Verify generated code exists (fail if missing)
        run: ./scripts/check-generated.sh

      # ---------- Gate 1: Lint + Assemble ----------
      - name: Lint & Assemble (fatal on warnings)
        run: |
          ./gradlew --stacktrace --no-daemon \
            lintDebug assembleDebug

      # 失败时把关键日志打出来 & 打包，便于定位
      - name: Dump Gradle error logs (always)
        if: always()
        run: |
          echo "---- manifest merger ----"
          find app/build/outputs -type f -name "manifest-merger*.txt" -print -exec sed -n '1,200p' {} \; || true
          echo "---- javac / kotlinc errors ----"
          find app/build -type f -name "*.log" -print -exec sed -n '1,200p' {} \; || true
          echo "---- lint results ----"
          find app/build/reports -type f \( -name "lint-results*.xml" -o -name "lint-results*.html" \) -print || true

      - name: Upload build reports (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-reports
          path: |
            app/build/outputs/**/*.txt
            app/build/reports/**/*

      # ---------- Gate 2: Robolectric Unit Tests (no device) ----------
      - name: Run unit tests (Robolectric smoke)
        run: |
          ./gradlew --stacktrace --no-daemon testDebugUnitTest

      # ---------- Gate 3: Emulator Smoke Run ----------
      - name: Emulator smoke run (15s crash monitor)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          arch: x86_64
          profile: pixel_5
          disable-animations: true
          script: |
            # /bin/sh 环境；只用 -e -u，避免 pipefail 兼容性问题
            set -eu

            # 1) 自动查找 debug APK
            APK="$(find app/build/outputs/apk/debug -maxdepth 1 -type f -name '*.apk' | head -n 1 || true)"
            if [ -z "$APK" ]; then
              echo "No APK found under app/build/outputs/apk/debug"
              echo "All APKs under outputs:"
              find app/build/outputs -type f -name '*.apk' -print || true
              exit 1
            fi
            echo "Found APK: $APK"

            # 2) 安装 APK
            adb install -r "$APK" >/dev/null

            # 3) 确保 aapt 可用（用 build-tools 自带）
            if ! command -v aapt >/dev/null 2>&1; then
              sdkmanager --install "build-tools;34.0.0"
              export PATH="$ANDROID_HOME/build-tools/34.0.0:$PATH"
            fi

            # 4) 解析包名与启动 Activity
            PKG="$(aapt dump badging "$APK" | awk -F\" '/package: name=/{print $2}')"
            ACT="$(aapt dump badging "$APK" | awk -F\" '/launchable-activity: name=/{print $2}')"
            echo "Detected package: $PKG"
            echo "Detected launcher: $ACT"

            # 5) 启动 App 并监控 15s 是否崩溃
            adb logcat -c
            adb shell am start -n "${PKG}/${ACT}"

            set +e
            # 用 sh 兼容的方式做超时与 grep
            timeout 15s sh -c 'adb logcat | tee /tmp/logcat.txt | grep -q -E "FATAL EXCEPTION|Process[[:space:]].*'"$PKG"'[[:space:]].*has died"'
            RES=$?
            set -e

            if [ "$RES" -eq 0 ]; then
              echo "Crash detected during smoke run:"
              tail -n 200 /tmp/logcat.txt || true
              exit 1
            else
              echo "Smoke run passed (no fatal crash in 15s)."
            fi

      # ---------- Artifact (only if all gates passed) ----------
      - name: Upload APK artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/*.apk
