name: Android Build (3 Templates Matrix)

on:
  workflow_dispatch:
    inputs:
      template:
        description: "Which template to build (leave 'all' to build all)"
        required: false
        type: choice
        options:
          - all
          - core-template
          - simple-template
          - form-template
        default: all

permissions:
  contents: read

concurrency:
  group: build-${{ github.ref }}-${{ github.workflow }}-${{ github.run_id }}
  cancel-in-progress: false

jobs:
  build:
    name: build (${{ matrix.template }})
    # 当 inputs.template == 'all' 或未指定时，三个模板都跑；
    # 如果指定了某个模板，就只跑匹配的那个。
    if: >
      ${{ inputs.template == '' ||
          inputs.template == 'all' ||
          matrix.template == inputs.template }}
    runs-on: ubuntu-latest
    timeout-minutes: 40

    strategy:
      fail-fast: false
      matrix:
        template: [core-template, simple-template, form-template]

    steps:
      - name: Checkout
      uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Grant execute permission for gradlew
        shell: bash
        run: |
          chmod +x "templates/${{ matrix.template }}/gradlew" || true
          chmod +x "templates/${{ matrix.template }}/gradlew.bat" || true

      - name: Build Release APK
        shell: bash
        working-directory: templates/${{ matrix.template }}
        run: |
          ./gradlew --no-daemon assembleRelease

      - name: List APKs (debug)
        shell: bash
        run: |
          echo "PWD=$(pwd)"
          echo "== List outputs =="
          ls -R "templates/${{ matrix.template }}/app/build/outputs" || true
          echo "== Find *.apk =="
          find "templates/${{ matrix.template }}/app/build" -name "*.apk" -type f -print

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-${{ matrix.template }}
          # 兼容不同 AGP 版本的产物路径；如果日志显示路径不同，请据实调整
          path: |
            templates/${{ matrix.template }}/app/build/outputs/apk/release/*.apk
            templates/${{ matrix.template }}/app/build/outputs/apk/**/release/*.apk
          if-no-files-found: error
          retention-days: 7
