name: Android Build

on:
  repository_dispatch:
    types: [ndjc_apply]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Fix gradlew permission
        run: chmod +x ./gradlew

      - name: Show triggering event and payload
        run: |
          echo "event=$GITHUB_EVENT_NAME"
          cat "$GITHUB_EVENT_PATH" || true

      # 高日志 + 保存控制台输出
      - name: Build release (with console log)
        run: |
          set -o pipefail
          ./gradlew clean :app:assembleRelease --no-daemon --stacktrace -i --warning-mode all | tee gradle-console.log

      - name: Upload APK artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: app/build/outputs/apk/release/*.apk

      # 失败时把 AAPT 与 Javac 的关键行打出来
      - name: Grep AAPT2 errors (on failure)
        if: failure()
        run: |
          echo "---- AAPT2 errors ----"
          grep -RIn "Android resource linking failed" app/build || true
          grep -RIn "^error:" app/build/outputs || true
          grep -RIn "AAPT: error" app/build || true
          echo "---- JAVAC errors ----"
          grep -RIn "cannot find symbol" app/build || true
          grep -RIn "\.java:[0-9]\+:" gradle-console.log || true
          tail -n 200 gradle-console.log || true
          echo "---- END ----"

      - name: Upload build logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: app-build-logs
          path: |
            gradle-console.log
            app/build/outputs/
            app/build/reports/
            **/*.log
            **/*.txt
